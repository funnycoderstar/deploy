<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CORS原理及@koa/cors源码解析 | 前端学习总结</title>
    <meta name="description" content="前端学习总结">
    <link rel="icon" href="https://cdn.wangyaxing.cn/icon-128x128.png">
    
    <link rel="preload" href="/summary/assets/css/0.styles.976d6aee.css" as="style"><link rel="preload" href="/summary/assets/js/app.42468a2d.js" as="script"><link rel="preload" href="/summary/assets/js/2.1ee37bec.js" as="script"><link rel="preload" href="/summary/assets/js/20.8d6622a1.js" as="script"><link rel="prefetch" href="/summary/assets/js/10.8eb1538c.js"><link rel="prefetch" href="/summary/assets/js/100.1ddcc6b4.js"><link rel="prefetch" href="/summary/assets/js/101.2bb5d105.js"><link rel="prefetch" href="/summary/assets/js/102.c12236a4.js"><link rel="prefetch" href="/summary/assets/js/103.919530c8.js"><link rel="prefetch" href="/summary/assets/js/104.073729fa.js"><link rel="prefetch" href="/summary/assets/js/105.b0f80c52.js"><link rel="prefetch" href="/summary/assets/js/106.799747b6.js"><link rel="prefetch" href="/summary/assets/js/107.cc99fda4.js"><link rel="prefetch" href="/summary/assets/js/108.3e73a198.js"><link rel="prefetch" href="/summary/assets/js/109.af5917b5.js"><link rel="prefetch" href="/summary/assets/js/11.34b775fd.js"><link rel="prefetch" href="/summary/assets/js/110.0f1298d0.js"><link rel="prefetch" href="/summary/assets/js/111.2e89ece1.js"><link rel="prefetch" href="/summary/assets/js/112.fad565e0.js"><link rel="prefetch" href="/summary/assets/js/113.a09f1c19.js"><link rel="prefetch" href="/summary/assets/js/114.43347d48.js"><link rel="prefetch" href="/summary/assets/js/115.96825ee2.js"><link rel="prefetch" href="/summary/assets/js/116.6cdb17d4.js"><link rel="prefetch" href="/summary/assets/js/117.90d5b3de.js"><link rel="prefetch" href="/summary/assets/js/118.99d0c2c2.js"><link rel="prefetch" href="/summary/assets/js/119.af945a16.js"><link rel="prefetch" href="/summary/assets/js/12.3ad1af9d.js"><link rel="prefetch" href="/summary/assets/js/120.1fb3b05b.js"><link rel="prefetch" href="/summary/assets/js/121.4d5750ab.js"><link rel="prefetch" href="/summary/assets/js/122.7e2047c3.js"><link rel="prefetch" href="/summary/assets/js/123.9fd343ce.js"><link rel="prefetch" href="/summary/assets/js/124.b2d07de2.js"><link rel="prefetch" href="/summary/assets/js/125.93161990.js"><link rel="prefetch" href="/summary/assets/js/126.83749704.js"><link rel="prefetch" href="/summary/assets/js/127.92f55989.js"><link rel="prefetch" href="/summary/assets/js/128.61fa9826.js"><link rel="prefetch" href="/summary/assets/js/129.363cccfd.js"><link rel="prefetch" href="/summary/assets/js/13.3c11b086.js"><link rel="prefetch" href="/summary/assets/js/130.28ccaf07.js"><link rel="prefetch" href="/summary/assets/js/131.0a31acc5.js"><link rel="prefetch" href="/summary/assets/js/132.e5bcaa1f.js"><link rel="prefetch" href="/summary/assets/js/133.c222d33b.js"><link rel="prefetch" href="/summary/assets/js/134.f1cb1ca2.js"><link rel="prefetch" href="/summary/assets/js/135.4be21204.js"><link rel="prefetch" href="/summary/assets/js/136.0c47aa82.js"><link rel="prefetch" href="/summary/assets/js/137.e912039e.js"><link rel="prefetch" href="/summary/assets/js/138.cddcd9f5.js"><link rel="prefetch" href="/summary/assets/js/139.1083da78.js"><link rel="prefetch" href="/summary/assets/js/14.8164a8d3.js"><link rel="prefetch" href="/summary/assets/js/140.4f21b0ac.js"><link rel="prefetch" href="/summary/assets/js/141.5e9002db.js"><link rel="prefetch" href="/summary/assets/js/142.8218a1c2.js"><link rel="prefetch" href="/summary/assets/js/143.7fb53e57.js"><link rel="prefetch" href="/summary/assets/js/144.7fd0b4ea.js"><link rel="prefetch" href="/summary/assets/js/145.6111dedb.js"><link rel="prefetch" href="/summary/assets/js/146.d55743a2.js"><link rel="prefetch" href="/summary/assets/js/147.5c2fa0c9.js"><link rel="prefetch" href="/summary/assets/js/148.1a62ad5e.js"><link rel="prefetch" href="/summary/assets/js/149.6a46114a.js"><link rel="prefetch" href="/summary/assets/js/15.36dbadda.js"><link rel="prefetch" href="/summary/assets/js/150.51fd6a8f.js"><link rel="prefetch" href="/summary/assets/js/151.8b6e7008.js"><link rel="prefetch" href="/summary/assets/js/152.748ade7f.js"><link rel="prefetch" href="/summary/assets/js/153.946244bf.js"><link rel="prefetch" href="/summary/assets/js/154.d2f651ea.js"><link rel="prefetch" href="/summary/assets/js/155.4a2335e5.js"><link rel="prefetch" href="/summary/assets/js/156.dc436376.js"><link rel="prefetch" href="/summary/assets/js/157.3708776f.js"><link rel="prefetch" href="/summary/assets/js/158.3364d602.js"><link rel="prefetch" href="/summary/assets/js/159.3975267e.js"><link rel="prefetch" href="/summary/assets/js/16.be6e7209.js"><link rel="prefetch" href="/summary/assets/js/160.db4f3aa6.js"><link rel="prefetch" href="/summary/assets/js/161.4255839e.js"><link rel="prefetch" href="/summary/assets/js/162.7c07c738.js"><link rel="prefetch" href="/summary/assets/js/17.f769a9df.js"><link rel="prefetch" href="/summary/assets/js/18.e061b4bb.js"><link rel="prefetch" href="/summary/assets/js/19.7dcb6be8.js"><link rel="prefetch" href="/summary/assets/js/21.fd7e385f.js"><link rel="prefetch" href="/summary/assets/js/22.86bee446.js"><link rel="prefetch" href="/summary/assets/js/23.98152607.js"><link rel="prefetch" href="/summary/assets/js/24.ff277d23.js"><link rel="prefetch" href="/summary/assets/js/25.38e5ece6.js"><link rel="prefetch" href="/summary/assets/js/26.4bf6adb2.js"><link rel="prefetch" href="/summary/assets/js/27.b9d7e61e.js"><link rel="prefetch" href="/summary/assets/js/28.2fc6a42c.js"><link rel="prefetch" href="/summary/assets/js/29.65730f32.js"><link rel="prefetch" href="/summary/assets/js/3.2d12c32b.js"><link rel="prefetch" href="/summary/assets/js/30.e57d5f14.js"><link rel="prefetch" href="/summary/assets/js/31.c7e63dce.js"><link rel="prefetch" href="/summary/assets/js/32.c404eb4d.js"><link rel="prefetch" href="/summary/assets/js/33.25e97b0c.js"><link rel="prefetch" href="/summary/assets/js/34.fef8ae97.js"><link rel="prefetch" href="/summary/assets/js/35.f3a436c9.js"><link rel="prefetch" href="/summary/assets/js/36.34412875.js"><link rel="prefetch" href="/summary/assets/js/37.808d0668.js"><link rel="prefetch" href="/summary/assets/js/38.69f44859.js"><link rel="prefetch" href="/summary/assets/js/39.0dd4d5dd.js"><link rel="prefetch" href="/summary/assets/js/4.db2c63af.js"><link rel="prefetch" href="/summary/assets/js/40.915d5c12.js"><link rel="prefetch" href="/summary/assets/js/41.2988d821.js"><link rel="prefetch" href="/summary/assets/js/42.43bdad6c.js"><link rel="prefetch" href="/summary/assets/js/43.a41754a4.js"><link rel="prefetch" href="/summary/assets/js/44.c01bdeea.js"><link rel="prefetch" href="/summary/assets/js/45.aa4207d1.js"><link rel="prefetch" href="/summary/assets/js/46.094733d2.js"><link rel="prefetch" href="/summary/assets/js/47.17c71655.js"><link rel="prefetch" href="/summary/assets/js/48.7771c0b7.js"><link rel="prefetch" href="/summary/assets/js/49.76301772.js"><link rel="prefetch" href="/summary/assets/js/5.15730f29.js"><link rel="prefetch" href="/summary/assets/js/50.5995e015.js"><link rel="prefetch" href="/summary/assets/js/51.e6b99fa3.js"><link rel="prefetch" href="/summary/assets/js/52.8c223934.js"><link rel="prefetch" href="/summary/assets/js/53.627a8fc4.js"><link rel="prefetch" href="/summary/assets/js/54.67a4db5f.js"><link rel="prefetch" href="/summary/assets/js/55.03f64c00.js"><link rel="prefetch" href="/summary/assets/js/56.7dccf975.js"><link rel="prefetch" href="/summary/assets/js/57.51c12383.js"><link rel="prefetch" href="/summary/assets/js/58.db835429.js"><link rel="prefetch" href="/summary/assets/js/59.168bc9ce.js"><link rel="prefetch" href="/summary/assets/js/6.00f0d033.js"><link rel="prefetch" href="/summary/assets/js/60.eb31f0c8.js"><link rel="prefetch" href="/summary/assets/js/61.4539e00c.js"><link rel="prefetch" href="/summary/assets/js/62.6c5b6dcf.js"><link rel="prefetch" href="/summary/assets/js/63.a913cf86.js"><link rel="prefetch" href="/summary/assets/js/64.5451dc6a.js"><link rel="prefetch" href="/summary/assets/js/65.13e91371.js"><link rel="prefetch" href="/summary/assets/js/66.da5553b2.js"><link rel="prefetch" href="/summary/assets/js/67.65c83c98.js"><link rel="prefetch" href="/summary/assets/js/68.3cb17917.js"><link rel="prefetch" href="/summary/assets/js/69.df0028cc.js"><link rel="prefetch" href="/summary/assets/js/7.1e0fdcbf.js"><link rel="prefetch" href="/summary/assets/js/70.0be8887e.js"><link rel="prefetch" href="/summary/assets/js/71.f084cd61.js"><link rel="prefetch" href="/summary/assets/js/72.d49a2556.js"><link rel="prefetch" href="/summary/assets/js/73.c0f3819e.js"><link rel="prefetch" href="/summary/assets/js/74.ff86e250.js"><link rel="prefetch" href="/summary/assets/js/75.8c02416e.js"><link rel="prefetch" href="/summary/assets/js/76.a7e8b1fb.js"><link rel="prefetch" href="/summary/assets/js/77.b9734522.js"><link rel="prefetch" href="/summary/assets/js/78.09e8c8fa.js"><link rel="prefetch" href="/summary/assets/js/79.020bb0a2.js"><link rel="prefetch" href="/summary/assets/js/8.393630e6.js"><link rel="prefetch" href="/summary/assets/js/80.8f953533.js"><link rel="prefetch" href="/summary/assets/js/81.835765fa.js"><link rel="prefetch" href="/summary/assets/js/82.fcc83f9a.js"><link rel="prefetch" href="/summary/assets/js/83.fe5ba7fa.js"><link rel="prefetch" href="/summary/assets/js/84.ddfa044f.js"><link rel="prefetch" href="/summary/assets/js/85.b91b8ecb.js"><link rel="prefetch" href="/summary/assets/js/86.c8bc3f53.js"><link rel="prefetch" href="/summary/assets/js/87.441e3f9e.js"><link rel="prefetch" href="/summary/assets/js/88.1b08f34a.js"><link rel="prefetch" href="/summary/assets/js/89.ff281bfb.js"><link rel="prefetch" href="/summary/assets/js/9.b20a9d51.js"><link rel="prefetch" href="/summary/assets/js/90.1b2f916d.js"><link rel="prefetch" href="/summary/assets/js/91.06d4b59d.js"><link rel="prefetch" href="/summary/assets/js/92.d23211f4.js"><link rel="prefetch" href="/summary/assets/js/93.b9840f77.js"><link rel="prefetch" href="/summary/assets/js/94.6c5f4070.js"><link rel="prefetch" href="/summary/assets/js/95.81384028.js"><link rel="prefetch" href="/summary/assets/js/96.5d3dc87e.js"><link rel="prefetch" href="/summary/assets/js/97.30921dca.js"><link rel="prefetch" href="/summary/assets/js/98.f0f74e7a.js"><link rel="prefetch" href="/summary/assets/js/99.d25ae723.js">
    <link rel="stylesheet" href="/summary/assets/css/0.styles.976d6aee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/summary/" class="home-link router-link-active"><!----> <span class="site-name">前端学习总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/summary/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/summary/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/summary/HTTP/" class="nav-link router-link-active">HTTP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/summary/React/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/summary/node/" class="nav-link">Node</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/tool/webpack/" class="nav-link">webpack</a></li><li class="dropdown-item"><!----> <a href="/summary/tool/babel.html" class="nav-link">babel</a></li><li class="dropdown-item"><!----> <a href="/summary/tool/other.html" class="nav-link">更多</a></li></ul></div></div><div class="nav-item"><a href="/summary/interview/" class="nav-link">面试题</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/new/" class="nav-link">新技术</a></li><li class="dropdown-item"><!----> <a href="/summary/translation/" class="nav-link">翻译</a></li><li class="dropdown-item"><!----> <a href="/summary/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/summary/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/summary/meteor/" class="nav-link">Meteor</a></li><li class="dropdown-item"><!----> <a href="/summary/test/" class="nav-link">Test</a></li><li class="dropdown-item"><!----> <a href="/summary/wxapp/" class="nav-link">微信小程序</a></li><li class="dropdown-item"><!----> <a href="/summary/Webkit/" class="nav-link">Webkit</a></li><li class="dropdown-item"><!----> <a href="/summary/Safe/" class="nav-link">安全</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/funnycoderstar/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/funnycoderstar/Front-end-summary" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/summary/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/summary/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/summary/HTTP/" class="nav-link router-link-active">HTTP</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/summary/React/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/summary/node/" class="nav-link">Node</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/tool/webpack/" class="nav-link">webpack</a></li><li class="dropdown-item"><!----> <a href="/summary/tool/babel.html" class="nav-link">babel</a></li><li class="dropdown-item"><!----> <a href="/summary/tool/other.html" class="nav-link">更多</a></li></ul></div></div><div class="nav-item"><a href="/summary/interview/" class="nav-link">面试题</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/summary/new/" class="nav-link">新技术</a></li><li class="dropdown-item"><!----> <a href="/summary/translation/" class="nav-link">翻译</a></li><li class="dropdown-item"><!----> <a href="/summary/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/summary/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/summary/meteor/" class="nav-link">Meteor</a></li><li class="dropdown-item"><!----> <a href="/summary/test/" class="nav-link">Test</a></li><li class="dropdown-item"><!----> <a href="/summary/wxapp/" class="nav-link">微信小程序</a></li><li class="dropdown-item"><!----> <a href="/summary/Webkit/" class="nav-link">Webkit</a></li><li class="dropdown-item"><!----> <a href="/summary/Safe/" class="nav-link">安全</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/funnycoderstar/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/funnycoderstar/Front-end-summary" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>HTTP</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/summary/HTTP/HTTP基础.html" class="sidebar-link">HTTP基础</a></li><li><a href="/summary/HTTP/cookie&amp;&amp;session&amp;&amp;token.html" class="sidebar-link">理解cookie，session, token</a></li><li><a href="/summary/HTTP/CORS.html" class="active sidebar-link">CORS原理及@koa/cors源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#为什么会有跨域问题？" class="sidebar-link">为什么会有跨域问题？</a></li><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#如何解决跨域" class="sidebar-link">如何解决跨域?</a></li><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#简单请求" class="sidebar-link">简单请求</a></li><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#非简单请求" class="sidebar-link">非简单请求</a></li><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#单独接口单独处理" class="sidebar-link">单独接口单独处理</a></li><li class="sidebar-sub-header"><a href="/summary/HTTP/CORS.html#写一个中间件进行处理" class="sidebar-link">写一个中间件进行处理</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cors原理及-koa-cors源码解析"><a href="#cors原理及-koa-cors源码解析" aria-hidden="true" class="header-anchor">#</a> CORS原理及@koa/cors源码解析</h1> <h1 id="目录"><a href="#目录" aria-hidden="true" class="header-anchor">#</a> 目录</h1> <ul><li>跨域</li> <li>简单请求和复杂请求</li> <li>服务端如何设置CORS</li> <li>@koa/cors是怎么实现的</li></ul> <h1 id="跨域"><a href="#跨域" aria-hidden="true" class="header-anchor">#</a> 跨域</h1> <h2 id="为什么会有跨域问题？"><a href="#为什么会有跨域问题？" aria-hidden="true" class="header-anchor">#</a> 为什么会有跨域问题？</h2> <p>这是浏览器的同源策略所造成的，同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。</p> <blockquote><p>一定要注意跨域是浏览器的限制，其实你用抓包工具抓取接口数据，是可以看到接口已经把数据返回回来了，只是浏览器的限制，你获取不到数据。用postman请求接口能够请求到数据。这些再次印证了跨域是浏览器的限制。</p></blockquote> <h2 id="如何解决跨域"><a href="#如何解决跨域" aria-hidden="true" class="header-anchor">#</a> 如何解决跨域?</h2> <ul><li>jsonp: 带有src属性的标签都可以用来， 但是只能处理GET请求</li> <li>document.domain + iframe跨域</li> <li>location.hash + iframe</li> <li>window.name + iframe</li> <li>postMessage跨域</li> <li>Nginx配置反向代理</li> <li>CORS（跨域资源共享）：支持所有类型的HTTP请求
相信大家对于以上的解决方法都很熟悉，这里不再对每一种方法展开讲解，接下来主要讲一下CORS；</li></ul> <h1 id="简单请求和非简单请求"><a href="#简单请求和非简单请求" aria-hidden="true" class="header-anchor">#</a> 简单请求和非简单请求</h1> <p>浏览器将<strong>CORS跨域请求</strong>分为简单请求和非简单请求；</p> <blockquote><p>如果你使用nginx反向代理解决的跨域问题，则不会有跨域请求这个说法了，因为nginx反向代理就使得前后端是同一个域了，就不存在跨域问题了。</p></blockquote> <p>只要同时满足一下两个条件，就属于简单请求
(1)使用下列方法之一：</p> <ul><li>head</li> <li>get</li> <li>post</li></ul> <p>(2)请求的Heder是</p> <ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Content-Type: 只限于三个值：
<ul><li>application/x-www-form-urlencoded</li> <li>multipart/form-data</li> <li>text/plain</li></ul></li></ul> <p>不同时满足上面的两个条件，就属于非简单请求。
浏览器对这两种的处理，是不一样的。</p> <h2 id="简单请求"><a href="#简单请求" aria-hidden="true" class="header-anchor">#</a> 简单请求</h2> <h3 id="例子"><a href="#例子" aria-hidden="true" class="header-anchor">#</a> 例子</h3> <p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是头信息之中，增加一个Origin字段。
<img src="https://cdn.suisuijiang.com/ImageMessage/5adad39555703565e79040fa_1560869800767.jpeg" alt="简单请求">
上面这个例子，<code>post</code>请求，<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>，满足简单请求的条件；响应头部返回<code>Access-Control-Allow-Origin: http://127.0.0.1:3000</code>;
浏览器发现这次跨域请求是简单请求，就自动在头信息之中，添加一个<code>Origin</code>字段；<code>Origin</code>字段用来说明请求来自哪个源（协议+域名+端口号）。服务端根据这个值，决定是否同意本次请求。</p> <h3 id="cors请求相关的字段，都以-access-control-开头"><a href="#cors请求相关的字段，都以-access-control-开头" aria-hidden="true" class="header-anchor">#</a> CORS请求相关的字段，都以 <code>Access-Control-</code>开头</h3> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Origin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：必选
<ul><li>请求头<code>Origin</code>字段的值</li> <li><code>*</code>：接受任何域名</li></ul></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Credentials<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：可选，
<ul><li>true: 表示允许发送cookie，此时<code>Access-Control-Allow-Origin</code>不能设置为<code>*</code>，必须指定明确的，与请求网页一致的域名。</li> <li>不设置该字段：不需要浏览器发送cookie</li></ul></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers" target="_blank" rel="noopener noreferrer">Access-Control-Expose-Headers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：可选
<ul><li>响应报头指示哪些报头可以公开为通过列出他们的名字的响应的一部分。默认情况下，只显示6个简单的响应标头：
<ul><li>Cache-Control</li> <li>Content-Language</li> <li>Content-Type</li> <li>Expires</li> <li>Last-Modified</li> <li>Pragma</li></ul></li> <li>如果想要让客户端可以访问到其他的首部信息，可以将它们在 Access-Control-Expose-Headers 里面列出来。</li></ul></li></ul> <h3 id="withcredentials-属性"><a href="#withcredentials-属性" aria-hidden="true" class="header-anchor">#</a> withCredentials 属性</h3> <p>CORS请求默认不发送Cookie和HTTP认证信息，如果要把Cookie发到服务器，一方面需要服务器同意，设置响应头<code>Access-Control-Allow-Credentials: true</code>,另一方面在客户端发出请求的时候也要进行一些设置;</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// XHR</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://example.com/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Fetch</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  credentials<span class="token punctuation">:</span> <span class="token string">'include'</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="非简单请求"><a href="#非简单请求" aria-hidden="true" class="header-anchor">#</a> 非简单请求</h2> <p>非简单请求就是那种对服务器有特殊要求的请求，比如请求方法为<code>PUT</code>或<code>DELETE</code>，或者<code>Content-Type</code>字段为<code>application/json</code>;</p> <h3 id="_1-预检请求和回应"><a href="#_1-预检请求和回应" aria-hidden="true" class="header-anchor">#</a> 1. 预检请求和回应</h3> <p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为“预检”请求；
浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段，只有得到肯定答复，浏览器才会发出正式的接口请求，否则就会报错；
<img src="https://cdn.suisuijiang.com/ImageMessage/5adad39555703565e79040fa_1560869817543.jpeg" alt="preflight"></p> <p>HTTP请求的方法是POST，请求头<code>Content-Type</code>字段为<code>application/json</code>。浏览器发现，这是一个非简单请求，就自动发出一个<code>预检</code>请求，要求服务器确认可以这样请求。</p> <h4 id="_1-1预检请求"><a href="#_1-1预检请求" aria-hidden="true" class="header-anchor">#</a> 1.1预检请求</h4> <p><code>预检</code>请求用的请求方法是OPTIONS，表示这个请求是用来询问的。头信息里面，关键字段是<code>Origin</code>，表示请求来自哪个域。
除了<code>Origin</code>，<code>预检</code>请求的头信息包括两个特殊字段：</p> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Request-Method" target="_blank" rel="noopener noreferrer">Access-Control-Request-Method<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>： 必选，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是<code>POST</code></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Request-Headers" target="_blank" rel="noopener noreferrer">Access-Control-Request-Headers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：该字段是一个用逗号分割的字符串，执行浏览器CORS请求会额外发送的头信息字段，上例是<code>Content-Type</code>;</li></ul> <h4 id="_1-2预检回应"><a href="#_1-2预检回应" aria-hidden="true" class="header-anchor">#</a> 1.2预检回应</h4> <p>服务器收到<code>预检</code>请求以后，检查了<code>Origin</code>、<code>Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>字段以后，确认允许跨域请求，就可以做出回应。
上面的HTTP回应中，关键的是Access-Control-Allow-Origin字段，表示http://127.0.0.1:3000可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p> <p>如果浏览器否定了“预检”请求，就会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段，这时，浏览器就会认定，服务器不同意预检请求，因此触发一个错误，被XMLHttpRequest对象的onerror回调函数捕获h。</p> <p>服务器回应的其他CORS字段</p> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Methods<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：必需；它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的方法。这是为了避免多次<code>预检</code>请求。</li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Headers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：如果浏览器请求头里包括<code>Access-Control-Request-Headers</code>字段，则<code>Access-Control-Allow-Headers</code>字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在<code>预检</code>中请求的字段。</li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Credentials<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：与简单请求时含义相同。</li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Max-Age" target="_blank" rel="noopener noreferrer">Access-Control-Allow-Max-Age<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: 可选，用来指定本次预检请求的有效期。单位为秒。在有效期内，不用发出另一条预检请求</li></ul> <h3 id="_2-正常请求和回应"><a href="#_2-正常请求和回应" aria-hidden="true" class="header-anchor">#</a> 2.正常请求和回应</h3> <p>一旦服务器通过了<code>预检</code>请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个<code>Origin</code>头信息字段。服务器的回应，也都会有一个<code>Access-Control-Allow-Origin</code>头信息字段；</p> <p><img src="https://cdn.suisuijiang.com/ImageMessage/5adad39555703565e79040fa_1560873193334.jpeg" alt="normal"></p> <h1 id="服务端如何设置cors"><a href="#服务端如何设置cors" aria-hidden="true" class="header-anchor">#</a> 服务端如何设置CORS</h1> <h2 id="单独接口单独处理"><a href="#单独接口单独处理" aria-hidden="true" class="header-anchor">#</a> 单独接口单独处理</h2> <p>比如一个简单的登录页面，需要给接口接口传入 username和password 两个字段；前端的域名为 localhost:8900，后端的域名为 localhost:3200，构成跨域。</p> <h3 id="_1-如果设置请求头-content-type-application-x-www-form-urlencoded-，这种情况则为简单请求；"><a href="#_1-如果设置请求头-content-type-application-x-www-form-urlencoded-，这种情况则为简单请求；" aria-hidden="true" class="header-anchor">#</a> 1. 如果设置请求头<code>'Content-Type': 'application/x-www-form-urlencoded'</code>，这种情况则为简单请求；</h3> <p>会有跨域问题，直接设置 响应头 <code>Access-Control-Allow-Origin</code>为<code>*</code>, 或者具体的域名；注意如果设置响应头<code>Access-Control-Allow-Credentials</code>为<code>true</code>，表示要发送<code>cookie</code>，则此时<code>Access-Control-Allow-Origin</code>的值不能设置为星号，必须指定明确的，与请求网页一致的域名。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userName <span class="token operator">=</span> req<span class="token punctuation">.</span>userName<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token string">'登陆成功'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-如果设置请求头-content-type-application-json-，这种情况则为非简单请求"><a href="#_2-如果设置请求头-content-type-application-json-，这种情况则为非简单请求" aria-hidden="true" class="header-anchor">#</a> 2. 如果设置请求头<code>'Content-Type': 'application/json'</code>，这种情况则为非简单请求</h3> <p>处理OPTIONS请求，服务端可以单独写一个路由，来处理<code>login</code>的OPTIONS的请求</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>大家都知道前端调用服务端的时候，会调用很多个接口，并且每个接口处理跨域请求的逻辑是完全一样的，我们可以把这部分抽离出来，作为一个中间件；</p> <h2 id="写一个中间件进行处理"><a href="#写一个中间件进行处理" aria-hidden="true" class="header-anchor">#</a> 写一个中间件进行处理</h2> <h3 id="首先了解一下koa中间件的“洋葱圈”模型"><a href="#首先了解一下koa中间件的“洋葱圈”模型" aria-hidden="true" class="header-anchor">#</a> 首先了解一下koa中间件的“洋葱圈”模型</h3> <p><img src="https://cdn.suisuijiang.com/ImageMessage/5adad39555703565e79040fa_1561047044232.png" alt="洋葱圈"></p> <p>将洋葱的一圈看做是一个中间件，直线型就是从第一个中间件走到最后一个，但是洋葱圈就很特殊了，最早use的中间件在洋葱最外层，开始的时候会按照顺序走到所有中间件，然后按照倒序再走一遍所有的中间件，相当于每个中间件都会进入两次，这就给了我们更多的操作空间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a - 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a - 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b - 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b - 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c - 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c - 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3200</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>输出</p> <div class="language-js extra-class"><pre class="language-js"><code>a <span class="token operator">-</span> <span class="token number">1</span>
b <span class="token operator">-</span> <span class="token number">1</span>
c <span class="token operator">-</span> <span class="token number">1</span>
c <span class="token operator">-</span> <span class="token number">2</span>
b <span class="token operator">-</span> <span class="token number">2</span>
a <span class="token operator">-</span> <span class="token number">2</span>
</code></pre></div><p>Koa官方文档上把外层的中间件称为“上游”，内层的中间件为“下游”。
一般的中间件都会执行两次，调用<code>next</code>之前为一次，调用<code>next</code>时把控制按顺序传递给下游的中间件。当下游不再有中间件或者中间件没有执行 <code>next</code> 函数时，就将依次恢复上游中间件的行为，让上游中间件执行 <code>next</code>之后的代码；</p> <h3 id="处理跨域的中间件简单示例"><a href="#处理跨域的中间件简单示例" aria-hidden="true" class="header-anchor">#</a> 处理跨域的中间件简单示例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 处理post请求的参数</span>

<span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userName <span class="token operator">=</span> req<span class="token punctuation">.</span>userName<span class="token punctuation">;</span>
    <span class="token keyword">const</span> expires <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600000</span><span class="token punctuation">;</span> <span class="token comment">// 设置超时时间为一小时后</span>
    
    <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> 
        iss<span class="token punctuation">:</span> userName<span class="token punctuation">,</span>
        exp<span class="token punctuation">:</span> expires
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> Token<span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token string">'登陆成功'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将公共逻辑方法放到中间件中处理</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> login<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3200</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h1 id="koa-cors是怎么实现的"><a href="#koa-cors是怎么实现的" aria-hidden="true" class="header-anchor">#</a> @koa/cors是怎么实现的</h1> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vary <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * CORS middleware
 *
 * @param {Object} [options]
 *  - {String|Function(ctx)} origin `Access-Control-Allow-Origin`, default is request Origin header
 *  - {String|Array} allowMethods `Access-Control-Allow-Methods`, default is 'GET,HEAD,PUT,POST,DELETE,PATCH'
 *  - {String|Array} exposeHeaders `Access-Control-Expose-Headers`
 *  - {String|Array} allowHeaders `Access-Control-Allow-Headers`
 *  - {String|Number} maxAge `Access-Control-Max-Age` in seconds
 *  - {Boolean} credentials `Access-Control-Allow-Credentials`
 *  - {Boolean} keepHeadersOnError Add set headers to `err.header` if an error is thrown
 * @return {Function} cors middleware
 * @api public
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> defaults <span class="token operator">=</span> <span class="token punctuation">{</span>
        allowMethods<span class="token punctuation">:</span> <span class="token string">'GET,HEAD,PUT,POST,DELETE,PATCH'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认的配置项和使用时设置的options进行一个融合</span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaults<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为函数的一些参数，exposeHeaders，allowMethods，allowHeaders的形式既可以是String,也可以是Array类型，</span>
    <span class="token comment">// 如果是Array类型,也转换为用逗号分隔的字符串。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>exposeHeaders<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>exposeHeaders <span class="token operator">=</span> options<span class="token punctuation">.</span>exposeHeaders<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>allowMethods<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>allowMethods <span class="token operator">=</span> options<span class="token punctuation">.</span>allowMethods<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>allowHeaders<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>allowHeaders <span class="token operator">=</span> options<span class="token punctuation">.</span>allowHeaders<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>maxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>maxAge <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    options<span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>credentials<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>keepHeadersOnError <span class="token operator">=</span> options<span class="token punctuation">.</span>keepHeadersOnError <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>keepHeadersOnError<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">cors</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the Origin header is not present terminate this set of steps.</span>
        <span class="token comment">// The request is outside the scope of this specification.</span>
        <span class="token keyword">const</span> requestOrigin <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Origin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Always set Vary header</span>
        <span class="token comment">// https://github.com/rs/cors/issues/10</span>
        ctx<span class="token punctuation">.</span><span class="token function">vary</span><span class="token punctuation">(</span><span class="token string">'Origin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果请求头不存在 origin，则直接跳出该中间件，执行下一个中间件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requestOrigin<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 对origin参数的不同类型做一个处理</span>
        <span class="token keyword">let</span> origin<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>origin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            origin <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">origin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> origin <span class="token operator">=</span> <span class="token keyword">await</span> origin<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            origin <span class="token operator">=</span> options<span class="token punctuation">.</span>origin <span class="token operator">||</span> requestOrigin<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> headersSet <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            headersSet<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        * 非OPTIONS请求的处理
        * 
        */</span>
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Simple Cross-Origin Request, Actual Request, and Redirects</span>
            <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>credentials <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>exposeHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Expose-Headers'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>exposeHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>keepHeadersOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> errHeadersSet <span class="token operator">=</span> err<span class="token punctuation">.</span>headers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> varyWithOrigin <span class="token operator">=</span> vary<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>errHeadersSet<span class="token punctuation">.</span>vary <span class="token operator">||</span> errHeadersSet<span class="token punctuation">.</span>Vary <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'Origin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">delete</span> errHeadersSet<span class="token punctuation">.</span>Vary<span class="token punctuation">;</span>

                err<span class="token punctuation">.</span>headers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> errHeadersSet<span class="token punctuation">,</span> headersSet<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    vary<span class="token punctuation">:</span> varyWithOrigin
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Preflight Request</span>

            <span class="token comment">// If there is no Access-Control-Request-Method header or if parsing failed,</span>
            <span class="token comment">// do not set any additional headers and terminate this set of steps.</span>
            <span class="token comment">// The request is outside the scope of this specification.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Request-Method'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// this not preflight request, ignore it</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>credentials <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>maxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Max-Age'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>allowMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>allowMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> allowHeaders <span class="token operator">=</span> options<span class="token punctuation">.</span>allowHeaders<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                allowHeaders <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Request-Headers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> allowHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>以上是 <a href="https://github.com/koajs/cors/blob/master/index.js" target="_blank" rel="noopener noreferrer">@koa/cors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> V3.0.0的源码实现，如果你真正理解的CORS，看源码的逻辑就会非常轻松。</p> <p>主要是分两个逻辑来处理，有预检请求的和没有预检请求的。</p> <p>对于非OPTIONS请求的处理，要根据情况加上 <code>Access-Control-Allow-Origin</code>，<code>Access-Control-Allow-Credentials</code>，<code>Access-Control-Expose-Headers</code>这三个响应头部；</p> <p>对于OPTIONS请求（预检请求）的处理，要根据情况加上 <code>Access-Control-Allow-Origin</code>，<code>Access-Control-Allow-Credentials</code>，<code>Access-Control-Max-Age</code>，<code>Access-Control-Allow-Methods</code>，<code>Access-Control-Allow-Headers</code>这几个响应头部；</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/summary/HTTP/cookie&amp;&amp;session&amp;&amp;token.html" class="prev">理解cookie，session, token</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/summary/assets/js/app.42468a2d.js" defer></script><script src="/summary/assets/js/2.1ee37bec.js" defer></script><script src="/summary/assets/js/20.8d6622a1.js" defer></script>
  </body>
</html>
